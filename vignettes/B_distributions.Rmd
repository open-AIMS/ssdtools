---
title: "Distributions in ssdtools"
author: "ssdtools Team"
date: "`r Sys.Date()`"
bibliography: references.bib
#output: rmarkdown::html_vignette
output: rmarkdown::pdf_document
vignette: >
  %\VignetteIndexEntry{Distributions in ssdtools}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.height = 4,
  fig.width = 6
)
```

## Distributions for SSD modelling

Many authors have noted that there is no guiding theory in ecotoxicology to justify any particular
distributional form for the SSD other than that its domain be restricted to the positive real line
(Newman et al. 2000, Zajdlik 2005, Chapman PF & Tarazona J 2007, Fox 2016).

Distributions selected to use in model averaging of SSDs must be bounded by zero given that effect concentrations cannot be negative. They must also be continuous, without an upper bound.

Furthermore, the selected distributions within the candidate model set should provide a variety of shapes to capture the diversity of shapes in empirical species sensitivity distributions.

There are a wide range of distributions that have been implemented in ssdtools, although not all distributions are among the recommended default set. Here we provide a detailed account of all the implemented distributions, and recommendations on their appropriate use.


### Original ssdtools distributions

The log-normal, log-logistic and Gamma distributions have been widely used in SSD modelling, and were part of the original distribution set for early releases of ssdtools as developed by [Thorley and Schwarz 2018](https://joss.theoj.org/papers/10.21105/joss.01082.pdf). They were adopted as the default set of three distributions in early updates of ssdtools and the associated ShinyApp [@dalgarno_shinyssdtools_2021]. All three of these distributions show good convergence properties and are retained as part of the default model set in the revised version of ssdtools.

In addition to the log-normal, log-logistic and Gamma distributions, the original version of ssdtools as developed by [Thorley and Schwarz 2018](https://joss.theoj.org/papers/10.21105/joss.01082.pdf) also included three additional distributions in the candidate model set, including the log-gumbel, Gompertz and Weibull distributions. Of these, the log-Gumbel (otherwise known as the inverse Weibull, see below) shows relatively good convergence [see Figure 32, @fox_methodologies_2021], and is also one of the limiting distributions of the Burrr Type 3 distribution implemented in ssdtools, and has been retained in the default model set. The Gompertz and Weibull distributions, however, both exhibit relatively unstable behaviour, sometimes showing poor convergence, and are therefore not currently recommended in the default set [see Figure 32, @fox_methodologies_2021]

### Burrlioz distributions

A history of Burrlioz and the primary distributions this software adopted were recently summmarized by @fox_recent_2021.

*"In 2000, Australia and New Zealand (Australian and New
Zealand Environment and Conservation Council/Agriculture
and Resource Management Council of Australia and New
Zealand 2000) adopted an SSD‐based method for deriving
WQBs, following a critical review of multiple WQB derivation
methods (Warne 1998). A distinct feature of the
method was the use of a 3‐parameter Burr distribution to
model the empirical SSD, which was implemented in the
Burrlioz software tool (Campbell et al. 2000). This represented
a generalization of the methods previously employed by
Aldenberg and Slob (1993) because the log–logistic distribution
was shown to be a speciﬁc case of the Burr family
(Tadikamalla 1980). Recent revision of the derivation method
recognized that using the 3‐parameter Burr distributions for
small sample sizes (<8 species) created additional uncertainty
by estimating more parameters than could be justiﬁed, essentially
overﬁtting the data (Batley et al. 2018). Consequently,
the method, and the updated software (Burrlioz Ver 2.0), now
uses a 2‐parameter log–logistic distribution for these small
data sets, whereas the Burr type III distribution is used for data
sets of 8 species or more (Batley et al. 2018; Australian and
New Zealand Guidelines 2018)."* &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; [@fox_recent_2021]

While the Burr type III distribution was adopted as the primary distribution in Burrlioz, it is well known (e.g., Tadikamalla (1980)) that the Burr III distribution is related to several other
theoretical distributions, some of
which only exist as limiting cases of the Burr III, i.e., as one or more of the Burr III
parameters approaches either zero or infinity. The Burrlioz software incorporates logic that aims
to identify situations where parameter estimates are converging to either very large or very
small values. In such cases, fitting a Burr III distribution is abandoned and one of the limiting
distributions is fitted instead. 

Specifically: 

 - As k tends to infinity the Burr III distribution tends to the inverse Weibull (log-Gumbel) distribution. 
 
 - As c tends to infinity the Burr III distribution tends to the inverse Pareto distribution.
 
In practical terms, if the Burr III distribution is fitted and k is estimated to be greater than 100, the estimation procedure is carried out again with a inverse Weibull distribution fitted.
Similarly for the inverse Pareto distribution, if c is greater than 80. This is necessary to
ensure numerical stability.

As the Burr type III, inverse Pareto and inverse Weibull (log Gumbel) distributions are all distributions adopted within the Burrlioz software, these have all been implemented in ssdtools. However, we have found there are stability issues with both the Burr type III, as well as the inverse Pareto distributions, which currently precludes their inclusion in the default model set (see @fox_methodologies_2021, and below for more details).

### Bimodal distributions

The use of statistical mixture-models was promoted by Fox as a convenient and more realistic way of
modelling bimodal toxicity data [@fisher2019]. Although parameter heavy, statistical mixture models
provide a better conceptual match to the inherent underlying data generating process since
they directly model bimodality as a mixture of 2 underlying univariate distributions that represent, for
example, different modes of action [@fox_recent_2021]. It has been postulated that a mixture-model
would only be selected in a model-averaging context when the fit afforded by the mixture is
demonstrably better than the fit afforded by any single distribution. This is a consequence of the high
penalty in AICc associated with the increased number of parameters (p in Equation 7 of [@fox_recent_2021]) and will be most pronounced for relatively small sample sizes.

The TMB version of ssdtools now includes the option of fitting two mixture distributions,
individually or as part of a model average set. These can be fit using ssdtools by supplying the strings "llogis_llogis" and/or "lnorm_lnorm" to the *dists* argument in the *ssd_fit_dists* call.

The underlying code for these mixtures has three components: the likelihood function
required for TMB; exported R functions to allow the usual methods for a distribution to be called (p, q
and r); and a set of supporting R functions (see @fox_methodologies_2021  Appendix D for more details). Both mixtures have five
parameters - two parameters for each of the component distributions and a mixing parameter (pmix)
that defines the weighting of the two distributions in the ‘mixture.’


## Default Distributions

While there are a large range of distributions available in ssdtools, not all of these are recommended to be used simultaneously for estimating a model averaged SSD.

By default, the ssdtools uses Akaike Information Criterion corrected for small sample size (AICc) as a measure of relative quality of fit for different distributions and as the basis for calculating the model-averaged HCx. However, model averaging results can be critically dependent on the candidate model set considered, and different results can be obtained if different candidate distributions are included.

Deciding on a final default set of distributions to adopt using the model averaging approach is not
trivial, and we acknowledge that there is probably no cut and dry ‘solution’ to this issue. However, the
default set should be underpinned by a guiding principle of parsimony, i.e., the set should be as large
as is necessary to cover a wide variety of distributional shapes and contingencies but no bigger.
Further, the default set should result in model averaged estimates of HCx values that: 1) minimise
bias; 2) have actual coverages of confidence intervals that are close to the nominal level of confidence;
3) estimated HCx and confidence intervals of HCx are robust to small changes in the data; and 4)
represent a positively continuous distribution that has both right and left tails.

The ssdtools development team have undertaken extensive simulation studies, as well as some detailed technical examinations of the various candidate distributions to examine issues of bias, coverage and numerical stability. A detailed account of our findings can be found in our report [@fox_methodologies_2021] and are not repeated in detail here, although some of the issues associated with individual distributions are outlined below.

### Currently recommended default distributions

The default list of candidate distributions in ssdtools should be comprised of the
following: log-normal; log-logistic; gamma; inverse Weibull (log-Gumbel); Weibull; mixture
of two log-normal distributions

The default distributions are plotted below with a mean of 2 and standard deviation of 2 on the (natural) log concentration scale or around 7.4 on the concentration scale.
```{r, message=FALSE}
library(ssdtools)
library(ggplot2)

theme_set(theme_bw())

set.seed(7)
ssd_plot_cdf(ssd_match_moments(meanlog = 2, sdlog = 2)) +
  scale_color_ssd()
```


## Distributions currently implemented in ssdtools

#### Log-normal
The [log-normal](https://en.wikipedia.org/wiki/Log-normal_distribution) distribution was selected as the starting distribution given the data are for effect concentrations. The log-normal distribution can be fit using ssdtools supplying the string "lnorm" to the *dists* argument in the *ssd_fit_dists* call.

The log-normal distribution does have a couple of limitations to consider when fitting species sensitivity data.
First, on the logarithmic scale, the normal distribution is symmetrical.
Second, the log-normal distribution decays too quickly in the tails giving narrow tails which may not adequately fit the data.
Additional distributions were selected to compensate for these deficiencies.  

#### Log-logistic distribution
The [log-logistic](https://en.wikipedia.org/wiki/Log-logistic_distribution) distribution is often used as a candidate SSD primarily because of its analytic tractability [@aldenberg_confidence_1993].
We included it because it has wider tails than the log-normal and because it is a specific case of the more general Burr family of distributions [@shao_estimation_2000, @burr_cumulative_1942]. The log-logistic distribution can be fit using ssdtools by supplying the string "lnorm" to the *dists* argument in the *ssd_fit_dists* call.

#### Gamma distribution
The [gamma](https://en.wikipedia.org/wiki/Gamma_distribution) distribution is a two-parameter distribution commonly used to model failure times or time to events.

For use in modeling species sensitivity data, the gamma distribution has two key features that provide additional flexibility relative to the log-normal distribution: 1) it is non-symmetrical on the logarithmic scale; and 2) it has wider tails.

The gamma distribution can be fit using ssdtools by supplying the string  "gamma" to the *dists* argument in the *ssd_fit_dists* call.  


#### Log-gumbel (inverse Weibull) distribution

The [log-gumbel](https://en.wikipedia.org/wiki/Gamma_distribution) distribution is a two-parameter distribution commonly used to model extreme values.

The Log-gumbel distribution can be fit using ssdtools by supplying the string "lgumbel" to the *dists* argument in the *ssd_fit_dists* call.  

#### Gompertz distribution

The [Gompertz](https://en.wikipedia.org/wiki/Gompertz_distribution) distribution is a flexible distribution that can be skewed to the right and to the left.
The Gompertz distribution can be fit using ssdtools by supplying the string "gompertz" to the *dists* argument in the *ssd_fit_dists* call. 

While available in ssdtools, the Gompertz distribution has been shown to be highly unstable [@@fox_methodologies_2021], and is not currently included in the recommended default set.

#### Weibull distribution

The [Weibull](https://en.wikipedia.org/wiki/Weibull_distribution) has been used previously in ssdtools for SSD modelling, and historically to model a broad range of random variables. It can be fit using ssdtools by supplying the string  "weibull" to the *dists* argument in the *ssd_fit_dists* call.  


#### Burr Type III distribution

The Burr Type 3 is a flexible three parameter distribution can be fit using ssdtools by supplying the string  "burrIII3"  to the *dists* argument in the *ssd_fit_dists* call.

The use of the Burr family of distributions has been central
to the derivation of guideline values in Australia and New
Zealand for over 20 yr [@fox_recent_2021]. While offering a high degree of ﬂexibility,
experience with these distributions during that time has
repeatedly highlighted numerical stability and convergence
issues when parameters are estimated using maximum likelihood [@fox_recent_2021].
This is thought to be due to the high degree of collinearity
between parameter estimates and/or relatively ﬂat
likelihood proﬁles [@fox_recent_2021], and is one of the motivations behind the logic coded into Burrlioz to revert to either of the two limiting distributions. Burr Type 3 distribution is not currently one of the recommended distributionsin the default model set. This is because of 1) the convergence issues associated with the Burr Type 3 distribution, 2) the fact that reverting to a limiting two parameter distribution does not fit easily within a model averaging framework, and 3) that one of the two limiting distributions (the inverse Pareto, see below) also has estimation and convergence issues.

#### Inverse Pareto distribution

The Inverse Pareto distribution can be fit using ssdtools by supplying the string "invpareto"  to the *dists* argument in the *ssd_fit_dists* call. 
While the inverse Pareto distribution is implemented in the Burrlioz 2.0 software, it is important
to understand that it is done so only as a limiting distribution. The inverse Pareto is not offered as a
stand-alone candidate SSD in the Burrlioz 2.0 software. We have spent considerable time and
effort exploring the properties of the inverse Pareto distribution, including deriving bias
correction equations and alternative methods for deriving confidence intervals [@fox_methodologies_2021]. This work has
substantial value for improving the current Burrlioz 2.0 method, and our bias corrections should
be adopted when deriving HCx estimates from the inverse Pareto where parameters have been
estimated using maximum likelihood.

As is the case with the Burrlioz 2.0 software, we have decided not to include the inverse Pareto
distribution as a default SSD model but instead reserving its use as a limiting form of the Burr III
distribution when the numerical calculations suggest this is necessary with the current Burrlioz
like framework. As a stand-alone SSD, the inverse Pareto distribution presents several difficulties. This
includes the requirement to make a choice between the so-called ‘European’ and ‘American’ versions
of the inverse Pareto distribution – the first being unbounded and the second being bounded to the 
right (which is problematic in the context of ecotoxicology); and potential problems with
bootstrapping estimation and inference. In addition, we have observed counter-intuitive results when
fitting the inverse Pareto distribution to certain data sets (for example, the ccme_boron dataset in
ssddata) whereby the likelihood (and hence model-average weight) is high but both a visual
inspection of the fitted distribution and the goodness-of-fit statistics reveal a demonstrably poorer fit
when compared to other ‘less likely’ distributions. This issue would require further investigation
before this distribution could be confidently included as a standalone distribution in the
recommended set.

The European version of the inverse Pareto distribution could potentially be added to ssdtools and
indeed it is already available in the R via the actuar package, however this was deemed to be
unwarranted. Our experience with actual toxicity data sets indicated that there was little difference
in the fits provided by the gamma distribution (already in the candidate list) and the European inverse
Pareto distribution. Further, mathematical theory dictates the use of the American version of the
inverse Pareto distribution as the limiting form of the Burr III under conditions outlined in Section 2.2.
It would therefore be confusing to use both versions of the inverse Pareto distribution in the
ssdtools software.

#### Inverse Weibull distribution (see log-Gumbel, above)

The inverse Weibull is mathematically equivalent to the log-Gumbel distribution described above. While which is also a limiting distribution of the Burr Type 3, this distribution does not show the same instability issues, and is unbounded to the right. It therefore represents a valid SSD distribution and is included in the default model set as a distribution in its own right.
The inverse Weibull distribution can be fit using ssdtools by supplying the string "lgumbel" to the *dists* argument in the *ssd_fit_dists* call. 
 
## References

<div id="refs"></div>

```{r, results = "asis", echo = FALSE}
cat(licensing_md())
```
